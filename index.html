<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Please describe the person in 50 words or less</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root { font-family: system-ui, -apple-system, Segoe UI, Arial, sans-serif; color-scheme: light; }
  body { margin: 0; background: #f6f7fb; color: #222; }
  .wrap { max-width: 780px; margin: 0 auto; padding: 24px; }
  .card { background: #fff; border-radius: 14px; box-shadow: 0 8px 28px rgba(0,0,0,.08); padding: 20px; }
  h1 { margin: 0 0 10px 0; font-size: 22px; }
  p { margin: 8px 0; color: #444; }
  .row { display: flex; gap: 8px; margin: 12px 0; flex-wrap: wrap; }
  input[type="text"], textarea {
    width: 100%; padding: 12px; border: 1px solid #dde1ea; border-radius: 10px; font-size: 16px; box-sizing: border-box;
  }
  textarea { min-height: 140px; }
  button { border: 0; padding: 12px 16px; border-radius: 10px; cursor: pointer; font-size: 15px; }
  .primary { background: #2d6cdf; color: #fff; }
  .ok { background: #17a34a; color: #fff; }
  .ghost { background: #eef2ff; color: #2d3a55; }
  .error { color: #b00020; margin-top: 6px; }
  .result { margin-top: 14px; padding: 16px; border: 1px solid #e8eaf2; border-radius: 10px; background: #fafbff; }
  .name { font-weight: 700; font-size: 18px; }
  .hide { display: none; }
  .muted { color: #6a7280; font-size: 14px; }
  label.small { font-size: 13px; color: #555; display: block; margin-top: 6px; }
  .counter { font-size: 12px; color: #666; text-align: right; }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Please describe the person in 50 words or less</h1>
    <p class="muted">Enter your own name, the page will reveal who you got, then submit your 50 word note. I can read the responses in a Google Sheet.</p>

    <!-- Step 1 -->
    <div id="stepIdentify">
      <div class="row">
        <input id="yourName" type="text" placeholder="Your full name">
        <button id="btnReveal" class="primary">Reveal</button>
      </div>
      <div id="errIdentify" class="error"></div>
    </div>

   <!-- Step 2 -->
<div id="stepAssigned" class="hide">
  <div class="result">
    <div>You will write about</div>
    <div class="name" id="assignee">...</div>
  </div>

  <!-- Example section -->
  <div style="background:#f1f4ff; border:1px solid #ccd3f6; border-radius:10px; padding:10px; margin:10px 0; font-size:14px; color:#333;">
    <strong>Example:</strong><br>
    Jesse’s the guy who’s always smiling, and you can hear his laugh from miles away. 
    He’s full of good vibes and makes every room lighter. Usually playful and joking, 
    but when he gets serious, you know it matters. The friend who makes life brighter just by showing up.
  </div>

  <label class="small">Your 50 word description</label>
  <textarea id="message" placeholder="Write up to 50 words"></textarea>
  <div class="counter"><span id="wordCount">0</span> of 50 words</div>
  <div class="row">
    <button id="btnSubmit" class="ok">Submit</button>
  </div>
  <div id="errSubmit" class="error"></div>
  <p class="muted">You can resubmit, I will see the latest one.</p>
</div>


    <!-- Step 3 -->
    <div id="stepDone" class="hide">
      <p class="result">Thanks, your response was recorded.</p>
      <button id="btnAnother" class="ghost">Submit again</button>
    </div>
  </div>
</div>

<script>
(function(){
  // ✅ Your actual Google Apps Script URL:
  const API_BASE = "https://script.google.com/macros/s/AKfycbz-MNGcTWJ42e1Z5pPrBoxvivU79j2apRzPl-8FCLT6CqpQLBZBgDf26Z_YsX6Zfh4-/exec";

  const $ = s => document.querySelector(s);
  const errIdentify = $("#errIdentify");
  const errSubmit = $("#errSubmit");
  const stepIdentify = $("#stepIdentify");
  const stepAssigned = $("#stepAssigned");
  const stepDone = $("#stepDone");
  const assigneeEl = $("#assignee");
  const btnReveal = $("#btnReveal");
  const btnSubmit = $("#btnSubmit");
  const btnAnother = $("#btnAnother");
  const inputName = $("#yourName");
  const txt = $("#message");
  const wordCount = $("#wordCount");

  function normalize(s){ return s ? s.normalize("NFKC").trim() : ""; }
  function countWords(s){ return normalize(s).split(/\s+/).filter(Boolean).length; }
  function lockName(name){ localStorage.setItem("lockedName", name); }
  function getLockedName(){ return localStorage.getItem("lockedName") || ""; }

  txt.addEventListener("input", () => {
    const n = countWords(txt.value);
    if (n > 50) {
      txt.value = txt.value.split(/\s+/).slice(0, 50).join(" ");
      wordCount.textContent = "50";
    } else {
      wordCount.textContent = String(n);
    }
  });

  // Auto load if name is already locked
  window.addEventListener("DOMContentLoaded", async () => {
    const locked = getLockedName();
    if (locked) {
      inputName.value = locked;
      inputName.disabled = true;
      btnReveal.disabled = true;
      try { await revealForName(locked, { auto: true }); } catch {}
    }
  });

  btnReveal.addEventListener("click", async () => {
    errIdentify.textContent = "";
    const name = normalize(inputName.value);
    if (!name) { errIdentify.textContent = "Enter your name."; return; }

    btnReveal.disabled = true;
    const originalLabel = btnReveal.textContent;
    btnReveal.textContent = "Revealing...";

    try {
      await revealForName(name);
      lockName(name);
      inputName.disabled = true;
      btnReveal.disabled = true;
    } catch(e) {
      errIdentify.textContent = e.message || "Could not reveal, try again.";
      btnReveal.disabled = false;
    } finally {
      btnReveal.textContent = originalLabel;
    }
  });

  async function revealForName(name) {
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), 15000);
    try{
      const url = new URL(API_BASE);
      url.searchParams.set("action", "assign");
      url.searchParams.set("name", name);
      url.searchParams.set("t", Date.now());
      const res = await fetch(url.toString(), { method: "GET", cache: "no-store", signal: controller.signal });
      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { throw new Error("Bad response from server"); }
      if (data.error) throw new Error(data.error);

      assigneeEl.textContent = data.recipient;
      sessionStorage.setItem("who_name", name);
      sessionStorage.setItem("who_recipient", data.recipient);

      stepIdentify.classList.add("hide");
      stepAssigned.classList.remove("hide");
      txt.focus();
    } finally {
      clearTimeout(t);
    }
  }

  btnSubmit.addEventListener("click", async () => {
    errSubmit.textContent = "";
    const msg = normalize(txt.value);
    const name = sessionStorage.getItem("who_name") || normalize(inputName.value);
    const recipient = sessionStorage.getItem("who_recipient") || assigneeEl.textContent.trim();

    if (!msg) { errSubmit.textContent = "Write your message first."; return; }
    if (countWords(msg) > 50) { errSubmit.textContent = "Please keep it to 50 words."; return; }

    try{
      const res = await fetch(API_BASE + "?action=submit", {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify({ name, recipient, message: msg })
      });
      const text = await res.text();
      let data; try { data = JSON.parse(text); } catch { data = {}; }
      if (data.error) throw new Error(data.error);

      stepAssigned.classList.add("hide");
      stepDone.classList.remove("hide");
    }catch(e){
      errSubmit.textContent = e.message || "Could not submit, try again.";
    }
  });

  btnAnother.addEventListener("click", () => {
    txt.value = "";
    wordCount.textContent = "0";
    stepDone.classList.add("hide");
    stepAssigned.classList.remove("hide");
  });
})();
</script>
</body>
</html>
